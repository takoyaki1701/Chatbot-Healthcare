<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chatbot Selftesting Popup</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div id="chat-button">üí¨</div>

<div id="chat-popup">
  <div id="chat-header">Tr·ª£ l√Ω s·ª©c kh·ªèe ·∫£o</div>
  <div id="chat-messages"></div>
  <div id="chat-input-area">
    <select id="mode-select" title="Ch·ªçn ch·∫ø ƒë·ªô chatbot"></select>
    <input id="chat-input" placeholder="Nh·∫≠p c√¢u h·ªèi ho·∫∑c tri·ªáu ch·ª©ng..." autocomplete="off" />
    <button id="chat-send-btn">G·ª≠i</button>
  </div>
  <div id="tts-control">
    <label><input type="checkbox" id="tts-toggle" checked> B·∫≠t gi·ªçng ƒë·ªçc</label>
  </div>
</div>

<script>
  const chatButton = document.getElementById("chat-button");
  const chatPopup = document.getElementById("chat-popup");
  const chatMessages = document.getElementById("chat-messages");
  const chatInput = document.getElementById("chat-input");
  const chatSendBtn = document.getElementById("chat-send-btn");
  const modeSelect = document.getElementById("mode-select");
  const ttsToggle = document.getElementById("tts-toggle");

  // Th√™m l·ª±a ch·ªçn ch·∫ø ƒë·ªô
  function populateModeOptions() {
    const options = [
      {value: "lookup", text: "Tra c·ª©u th√¥ng tin"},
      {value: "diagnosis", text: "Ch·∫©n ƒëo√°n tri·ªáu ch·ª©ng"}
    ];
    for(let opt of options){
      let el = document.createElement("option");
      el.value = opt.value;
      el.textContent = opt.text;
      modeSelect.appendChild(el);
    }
  }
  populateModeOptions();

  chatButton.onclick = () => {
    if (chatPopup.style.display === "flex") chatPopup.style.display = "none";
    else {
      chatPopup.style.display = "flex";
      if (!chatMessages.innerHTML) {
        chatMessages.innerHTML += `<div class="bot-msg message">Ch√†o b·∫°n! T√¥i l√† tr·ª£ l√Ω s·ª©c kh·ªèe ·∫£o. B·∫°n c√≥ th·ªÉ ch·ªçn ch·∫ø ƒë·ªô v√† b·∫Øt ƒë·∫ßu nh·∫≠p.</div>`;
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }
  };

  async function sendMessage() {
    let msg = chatInput.value.trim();
    if (!msg) return;

    const mode = modeSelect.value;

    chatMessages.innerHTML += `<div class="user-msg message">${msg}</div>`;
    chatInput.value = "";
    chatMessages.scrollTop = chatMessages.scrollHeight;

    try {
      const res = await fetch("/chat", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({message: msg, mode: mode})
      });
      const data = await res.json();

      chatMessages.innerHTML += `<div class="bot-msg message">${data.reply}</div>`;
      chatMessages.scrollTop = chatMessages.scrollHeight;

      if (ttsToggle.checked && 'speechSynthesis' in window) {
        let utterance = new SpeechSynthesisUtterance(data.reply);
        utterance.lang = 'vi-VN';  // Gi·ªçng ti·∫øng Vi·ªát
        window.speechSynthesis.speak(utterance);
      } else if (!('speechSynthesis' in window)) {
        console.log("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Speech Synthesis.");
      }

      if(mode === "diagnosis"){
        if(data.reply.toLowerCase().includes("k·∫øt qu·∫£") || data.reply.toLowerCase().includes("d·ª± ƒëo√°n b·ªánh")){
          modeSelect.value = "lookup";
          chatMessages.innerHTML += `<div class="bot-msg message"><i>Ch·∫©n ƒëo√°n ho√†n th√†nh. B·∫°n c√≥ th·ªÉ ch·ªçn l·∫°i ch·∫ø ƒë·ªô.</i></div>`;
        }
      }

    } catch (err) {
      chatMessages.innerHTML += `<div class="bot-msg message">L·ªói k·∫øt n·ªëi m√°y ch·ªß.</div>`;
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  }

  chatSendBtn.onclick = sendMessage;
  chatInput.addEventListener("keypress", e => {
    if (e.key === "Enter") sendMessage();
  });
</script>

</body>
</html>
